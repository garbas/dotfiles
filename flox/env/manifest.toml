version = 1

[install]
# load_flox_op
_1password-cli.pkg-path = "_1password-cli"
ripgrep.pkg-path = "ripgrep"
jq.pkg-path = "jq"

# load_flox_macos
mac-app-util.flake = "github:hraban/mac-app-util"
mac-app-util.systems = ["x86_64-darwin", "aarch64-darwin"]

# TODO: load_flox_tmux
tmux.pkg-path = "tmux"
cargo.pkg-path = "cargo"
rustc.pkg-path = "rustc"
nodejs.pkg-path = "nodejs"
"flox/flox-mcp-server".pkg-path = "flox/flox-mcp-server"
"flox/flox-mcp-server".systems = ["aarch64-darwin", "x86_64-linux"]
"flox/flox-mcp-server".pkg-group = "flox/flox-mcp-server"
github-mcp-server.pkg-path = "github-mcp-server"
claude-code.pkg-path = "claude-code"
codex.pkg-path = "codex"
gemini-cli.pkg-path = "gemini-cli"
opencode.pkg-path = "opencode"
amazon-q-cli.pkg-path = "amazon-q-cli"
playwright-mcp.pkg-path = "playwright-mcp"

[vars]
OP_ACCOUNT="my.1password.com"
OP_SECRETS_ITEM="Terminal"
OP_SECRETS = "OPENAI_API_KEY HF_TOKEN CLAUDE_GITHUB_MCP_TOKEN"
TMUX_SESSION_NAME = "flox-session"

[hook]
on-activate = '''

load_flox_op () {
  echo "ðŸ”‘ Loading secrets from 1Password";
  eval $(op --account $OP_ACCOUNT signin)
  __SECRETS="$(op --account $OP_ACCOUNT item get $OP_SECRETS_ITEM --format json)"
  for secret in $OP_SECRETS; do
    echo "  ó°Š Exporting $secret secret";
    export $secret=$(echo $__SECRETS | jq -r ".fields[] | select(.label == \"$secret\") | .value");
  done
  unset secret;
  unset __SECRETS;
}

load_flox_macos () {
  __ENV_NAME=$(echo $_FLOX_ACTIVE_ENVIRONMENTS | jq -r '.[0].pointer.name')
  __ENV_APPS="$HOME/Applications/Flox ($__ENV_NAME) Apps"
  if [[ -d $__ENV_APPS ]]; then
    rm -rf "$__ENV_APPS"
  fi
  if [ -d $FLOX_ENV/Applications ]; then 
    mac-app-util sync-trampolines \
      "$FLOX_ENV/Applications" \
      "$__ENV_APPS"
  fi
}

load_flox_op

if command -v mac-app-util 2>&1 >/dev/null; then
  load_flox_macos
fi
'''

[profile]
common = '''
# Starting/Attaching to TMUX session
#
# DISABLED: Automatic tmux session management is currently disabled.
# Reason: User preference - no auto-activation of tmux when opening Flox environment.
# To re-enable: Uncomment the code below and adjust to your preferences.
#
# When enabled, automatically creates/attaches to tmux session.
# Skip tmux management if:
# - Already inside a tmux session
# - Inside a Neovim terminal
# - Not in an interactive shell
#if [ -z "$TMUX" ] && [ -z "$NVIM_LISTEN_ADDRESS" ] && [ -n "$PS1" ]; then
#  # Check if the session already exists
#  if ! tmux has-session -t "$TMUX_SESSION_NAME" 2>/dev/null; then
#    echo "ðŸ“º Creating new tmux session: $TMUX_SESSION_NAME"
#    tmux new-session -s "$TMUX_SESSION_NAME" -n "main"
#  else
#    echo "ðŸ“º Attaching to existing tmux session: $TMUX_SESSION_NAME"
#    tmux attach-session -t "$TMUX_SESSION_NAME"
#  fi
#fi
'''

[options]
systems = [
  "aarch64-darwin",
  "aarch64-linux",
  "x86_64-darwin",
  "x86_64-linux",
]
